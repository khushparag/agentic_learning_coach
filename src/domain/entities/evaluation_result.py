"""
EvaluationResult domain entity for the Agentic Learning Coach system.
"""
from dataclasses import dataclass, field
from datetime import datetime
from typing import Dict, Optional, Any
from uuid import uuid4


@dataclass
class EvaluationResult:
    """
    Domain entity representing the evaluation result of a submission.
    
    Evaluation results contain test outputs, feedback, scores, and
    other assessment data generated by the ReviewerAgent.
    """
    submission_id: str
    passed: bool
    score: float
    feedback: Dict[str, Any]
    execution_time: float
    test_results: Optional[Dict[str, Any]] = None
    id: str = field(default_factory=lambda: str(uuid4()))
    evaluated_at: datetime = field(default_factory=datetime.utcnow)
    
    def __post_init__(self):
        """Validate the evaluation result data after initialization."""
        if not self.submission_id:
            raise ValueError("submission_id cannot be empty")
        
        if not isinstance(self.passed, bool):
            raise ValueError("passed must be a boolean")
        
        if not isinstance(self.feedback, dict):
            raise ValueError("feedback must be a dictionary")
        
        if not (0.0 <= self.score <= 100.0):
            raise ValueError("score must be between 0.0 and 100.0")
        
        if self.execution_time < 0:
            raise ValueError("execution_time must be non-negative")
    
    def is_passing(self) -> bool:
        """Check if this evaluation represents a passing result."""
        return self.passed
    
    def is_failing(self) -> bool:
        """Check if this evaluation represents a failing result."""
        return not self.passed
    
    def has_test_results(self) -> bool:
        """Check if test results are available."""
        return self.test_results is not None and len(self.test_results) > 0
    
    def get_test_summary(self) -> Dict[str, Any]:
        """Get a summary of test execution results."""
        if not self.test_results:
            return {'total_tests': 0, 'passed_tests': 0, 'failed_tests': 0}
        
        if isinstance(self.test_results, list):
            total_tests = len(self.test_results)
            passed_tests = sum(1 for test in self.test_results if test.get('passed', False))
        else:
            total_tests = self.test_results.get('total_tests', 0)
            passed_tests = self.test_results.get('passed_tests', 0)
        
        return {
            'total_tests': total_tests,
            'passed_tests': passed_tests,
            'failed_tests': total_tests - passed_tests,
            'execution_time': self.execution_time
        }
    
    def get_feedback_summary(self) -> str:
        """Get a concise summary of the feedback."""
        return self.feedback.get('overall_assessment', 'No feedback available')
    
    def to_dict(self) -> Dict[str, Any]:
        """Convert the evaluation result to a dictionary representation."""
        return {
            'id': self.id,
            'submission_id': self.submission_id,
            'passed': self.passed,
            'score': self.score,
            'feedback': self.feedback.copy(),
            'execution_time': self.execution_time,
            'test_results': self.test_results.copy() if self.test_results else None,
            'evaluated_at': self.evaluated_at.isoformat()
        }
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'EvaluationResult':
        """Create an EvaluationResult from a dictionary representation."""
        return cls(
            id=data['id'],
            submission_id=data['submission_id'],
            passed=data['passed'],
            score=data['score'],
            feedback=data['feedback'],
            execution_time=data['execution_time'],
            test_results=data.get('test_results'),
            evaluated_at=datetime.fromisoformat(data['evaluated_at'])
        )