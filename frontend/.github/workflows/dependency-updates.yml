name: Dependency Updates & Security Patches

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM UTC
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - security

env:
  NODE_VERSION: '20.x'

jobs:
  # Security Updates (High Priority)
  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'security' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      working-directory: frontend
      run: npm ci --prefer-offline --no-audit
      
    - name: Audit and fix security vulnerabilities
      working-directory: frontend
      run: |
        # Generate audit report
        npm audit --audit-level=moderate --json > audit-before.json || true
        
        # Attempt automatic fixes
        npm audit fix --audit-level=moderate || true
        
        # Generate post-fix report
        npm audit --audit-level=moderate --json > audit-after.json || true
        
        # Check if fixes were applied
        if ! cmp -s audit-before.json audit-after.json; then
          echo "SECURITY_FIXES_APPLIED=true" >> $GITHUB_ENV
        else
          echo "SECURITY_FIXES_APPLIED=false" >> $GITHUB_ENV
        fi
        
    - name: Run tests after security fixes
      if: env.SECURITY_FIXES_APPLIED == 'true'
      working-directory: frontend
      run: |
        npm run type-check
        npm run lint
        npm run test:ci
        
    - name: Create security update PR
      if: env.SECURITY_FIXES_APPLIED == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'security: fix npm audit vulnerabilities'
        title: 'ðŸ”’ Security: Fix npm audit vulnerabilities'
        body: |
          ## Security Updates Applied
          
          This PR contains automatic security fixes for npm audit vulnerabilities.
          
          ### Changes
          - Applied `npm audit fix` to resolve security vulnerabilities
          - All tests pass after applying fixes
          
          ### Audit Reports
          - Before: See `audit-before.json`
          - After: See `audit-after.json`
          
          ### Verification
          - [x] Type checking passes
          - [x] Linting passes  
          - [x] Unit tests pass
          
          **Auto-generated by security update workflow**
        branch: security/npm-audit-fixes
        delete-branch: true
        labels: |
          security
          dependencies
          automated
        assignees: ${{ github.actor }}

  # Patch Updates
  patch-updates:
    name: Patch Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'patch' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install npm-check-updates
      run: npm install -g npm-check-updates
      
    - name: Update patch versions
      working-directory: frontend
      run: |
        # Update patch versions only
        ncu --target patch --upgrade
        
        # Install updated dependencies
        npm install
        
        # Check if updates were applied
        if git diff --quiet package.json package-lock.json; then
          echo "PATCH_UPDATES_APPLIED=false" >> $GITHUB_ENV
        else
          echo "PATCH_UPDATES_APPLIED=true" >> $GITHUB_ENV
        fi
        
    - name: Run comprehensive tests
      if: env.PATCH_UPDATES_APPLIED == 'true'
      working-directory: frontend
      run: |
        npm run type-check
        npm run lint
        npm run test:ci
        npm run build
        
    - name: Create patch update PR
      if: env.PATCH_UPDATES_APPLIED == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'deps: update patch versions'
        title: 'â¬†ï¸ Dependencies: Update patch versions'
        body: |
          ## Patch Version Updates
          
          This PR contains automatic patch version updates for dependencies.
          
          ### Changes
          - Updated all dependencies to latest patch versions
          - All tests pass after updates
          
          ### Verification
          - [x] Type checking passes
          - [x] Linting passes
          - [x] Unit tests pass
          - [x] Build succeeds
          
          **Auto-generated by dependency update workflow**
        branch: deps/patch-updates
        delete-branch: true
        labels: |
          dependencies
          patch
          automated

  # Minor Updates (Manual Review Required)
  minor-updates:
    name: Minor Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'minor'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install npm-check-updates
      run: npm install -g npm-check-updates
      
    - name: Generate minor update report
      working-directory: frontend
      run: |
        # Generate update report
        ncu --target minor --format json > minor-updates-available.json
        ncu --target minor > minor-updates-report.txt
        
        # Check if updates are available
        if [ -s minor-updates-available.json ] && [ "$(cat minor-updates-available.json)" != "{}" ]; then
          echo "MINOR_UPDATES_AVAILABLE=true" >> $GITHUB_ENV
        else
          echo "MINOR_UPDATES_AVAILABLE=false" >> $GITHUB_ENV
        fi
        
    - name: Create minor update issue
      if: env.MINOR_UPDATES_AVAILABLE == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('frontend/minor-updates-report.txt', 'utf8');
          
          const title = `Minor Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Minor Dependency Updates Available
          
          The following minor version updates are available for review:
          
          \`\`\`
          ${report}
          \`\`\`
          
          ### Action Required
          1. Review the changelog for each updated dependency
          2. Test the updates in a development environment
          3. Create a PR with the updates if safe to apply
          
          ### Commands to Apply Updates
          \`\`\`bash
          cd frontend
          ncu --target minor --upgrade
          npm install
          npm run test:all
          \`\`\`
          
          **Auto-generated by dependency update workflow**
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['dependencies', 'minor', 'review-required']
          });

  # Major Updates (Manual Review Required)
  major-updates:
    name: Major Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'major'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install npm-check-updates
      run: npm install -g npm-check-updates
      
    - name: Generate major update report
      working-directory: frontend
      run: |
        # Generate update report
        ncu --target major --format json > major-updates-available.json
        ncu --target major > major-updates-report.txt
        
        # Check if updates are available
        if [ -s major-updates-available.json ] && [ "$(cat major-updates-available.json)" != "{}" ]; then
          echo "MAJOR_UPDATES_AVAILABLE=true" >> $GITHUB_ENV
        else
          echo "MAJOR_UPDATES_AVAILABLE=false" >> $GITHUB_ENV
        fi
        
    - name: Create major update issue
      if: env.MAJOR_UPDATES_AVAILABLE == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('frontend/major-updates-report.txt', 'utf8');
          
          const title = `Major Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Major Dependency Updates Available âš ï¸
          
          The following major version updates are available and require careful review:
          
          \`\`\`
          ${report}
          \`\`\`
          
          ### âš ï¸ Important Notes
          - Major version updates may contain breaking changes
          - Thorough testing is required before applying
          - Review migration guides for each dependency
          - Consider updating dependencies one at a time
          
          ### Action Required
          1. **Review breaking changes** for each dependency
          2. **Read migration guides** and changelogs
          3. **Test updates individually** in a development environment
          4. **Update code** to handle breaking changes
          5. **Run comprehensive test suite**
          6. **Create PR** with updates and necessary code changes
          
          ### Commands to Check Updates
          \`\`\`bash
          cd frontend
          ncu --target major
          \`\`\`
          
          **Auto-generated by dependency update workflow**
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['dependencies', 'major', 'breaking-changes', 'high-priority']
          });

  # Dependency Health Check
  dependency-health:
    name: Dependency Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      working-directory: frontend
      run: npm ci --prefer-offline --no-audit
      
    - name: Check for outdated dependencies
      working-directory: frontend
      run: |
        npm outdated --json > outdated-deps.json || true
        npm outdated > outdated-deps.txt || true
        
    - name: Check for unused dependencies
      working-directory: frontend
      run: |
        npx depcheck --json > unused-deps.json || true
        npx depcheck > unused-deps.txt || true
        
    - name: Analyze bundle impact
      working-directory: frontend
      run: |
        npm run build:analyze
        npx webpack-bundle-analyzer dist/stats.json --report --mode static --report-filename bundle-analysis.html
        
    - name: Generate dependency health report
      working-directory: frontend
      run: |
        echo "# Dependency Health Report" > dependency-health-report.md
        echo "" >> dependency-health-report.md
        echo "Generated on: $(date -u)" >> dependency-health-report.md
        echo "" >> dependency-health-report.md
        
        echo "## Outdated Dependencies" >> dependency-health-report.md
        echo "\`\`\`" >> dependency-health-report.md
        cat outdated-deps.txt >> dependency-health-report.md
        echo "\`\`\`" >> dependency-health-report.md
        echo "" >> dependency-health-report.md
        
        echo "## Unused Dependencies" >> dependency-health-report.md
        echo "\`\`\`" >> dependency-health-report.md
        cat unused-deps.txt >> dependency-health-report.md
        echo "\`\`\`" >> dependency-health-report.md
        
    - name: Upload dependency health reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-health-reports
        path: |
          frontend/dependency-health-report.md
          frontend/outdated-deps.json
          frontend/unused-deps.json
          frontend/bundle-analysis.html
        retention-days: 30

  # Cleanup old dependency update branches
  cleanup:
    name: Cleanup Old Branches
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Delete old dependency branches
      run: |
        # Delete merged dependency update branches older than 7 days
        git for-each-ref --format='%(refname:short) %(committerdate)' refs/remotes/origin/deps/ refs/remotes/origin/security/ | \
        while read branch date; do
          if [[ $(date -d "$date" +%s) -lt $(date -d "7 days ago" +%s) ]]; then
            echo "Deleting old branch: $branch"
            git push origin --delete "${branch#origin/}" || true
          fi
        done